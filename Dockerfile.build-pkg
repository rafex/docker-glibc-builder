FROM alpine:latest as glibc-builder-pkg

LABEL maintainer="Rafex <rafex@rafex.dev>"

ARG user=abuild \ 
	path=/builder \
    GLIBC_VERSION=2.39 

RUN apk --no-cache add alpine-sdk coreutils
RUN adduser -G $user -g "Alpine Package Builder" -s /bin/ash -D builder && \
    echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p $path/upstream
    
     
COPY glibc-bin-${GLIBC_VERSION}.tar.gz $path/upstream
COPY ["APKBUILD", "glibc-bin.trigger", "ld.so.conf", "nsswitch.conf", "/builder/upstream/"]

USER $user
WORKDIR $path

RUN abuild-keygen -a -i -n && \
    mkdir -p packages && \
    sudo chown -R builder:abuild upstream packages && \
    cd upstream && \
    abuild checksum && \
    abuild -r

ENTRYPOINT ["/builder"]
